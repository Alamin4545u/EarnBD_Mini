<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Auto Ad</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #050505;
            color: #00e5ff;
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .dashboard {
            width: 85%;
            padding: 25px;
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid rgba(0, 229, 255, 0.3);
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        h2 { margin: 0 0 20px 0; font-size: 22px; letter-spacing: 2px; }

        .loader-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid rgba(0, 229, 255, 0.1);
            border-top: 4px solid #00e5ff;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
        }

        .timer-text {
            font-size: 40px;
            font-weight: bold;
            animation: none; /* Text shouldn't spin */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stop spinning when waiting */
        .loader-ring.paused { animation: none; border-color: #333; }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn {
            background: #00e5ff;
            color: #000;
            border: none;
            padding: 12px 30px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            margin-top: 20px;
        }
        
        #status { font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="dashboard">
        <h2>AUTO AD SYSTEM</h2>

        <div class="loader-ring" id="ring">
            <div class="timer-text" id="timer">00</div>
        </div>
        <div id="status">READY TO START</div>

        <div class="stats">
            <div>
                <div style="font-size:10px; color:#aaa;">IMPRESSIONS</div>
                <div id="imp" style="font-size:20px;">0</div>
            </div>
            <div>
                <div style="font-size:10px; color:#aaa;">CYCLES</div>
                <div id="cyc" style="font-size:20px;">0</div>
            </div>
        </div>

        <button class="btn" id="startBtn" onclick="startSystem()">START ENGINE</button>
    </div>

    <!-- Script Container (Dynamic injection happen here) -->
    <div id="ad-script-container"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const AD_DURATION = 15;
        const GAP_DURATION = 3; // Gap একটু বাড়ালাম যাতে স্ক্রিপ্ট লোড হতে সময় পায়

        let isRunning = false;
        let impressions = 0;
        let cycles = 0;

        const timerEl = document.getElementById('timer');
        const statusEl = document.getElementById('status');
        const ringEl = document.getElementById('ring');
        const impEl = document.getElementById('imp');
        const cycEl = document.getElementById('cyc');

        function startSystem() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            runLoop();
        }

        async function runLoop() {
            // ১. গ্যাপ ফেইজ (পুরানো সব ক্লিন করা)
            cleanupAds();
            ringEl.classList.add('paused');
            await countdown(GAP_DURATION, "LOADING NEW AD...");

            // ২. নতুন স্ক্রিপ্ট লোড করা (Re-Injection)
            statusEl.innerText = "REQUESTING AD...";
            loadAdScript();

            // ৩. অ্যাড শো করার জন্য একটু সময় দেওয়া (১ সেকেন্ড)
            await new Promise(r => setTimeout(r, 1500)); 

            // ৪. অ্যাড দেখানোর চেষ্টা
            tryShowAd();

            // ৫. অ্যাড দেখার সময় (১৫ সেকেন্ড)
            ringEl.classList.remove('paused');
            await countdown(AD_DURATION, "WATCHING AD...");

            // ৬. লুপ শেষ, কাউন্টার আপডেট
            cycles++;
            cycEl.innerText = cycles;
            
            // ৭. আবার শুরু
            runLoop();
        }

        function loadAdScript() {
            // পুরানো কন্টেইনার খালি করা
            const container = document.getElementById('ad-script-container');
            container.innerHTML = ''; 

            // নতুন স্ক্রিপ্ট তৈরি
            const script = document.createElement('script');
            // Cache এড়ানোর জন্য টাইমস্ট্যাম্প যোগ করা হলো (?t=...)
            script.src = '//libtl.com/sdk.js?t=' + Date.now(); 
            script.setAttribute('data-zone', '10197154');
            script.setAttribute('data-sdk', 'show_10197154');
            
            container.appendChild(script);
        }

        function tryShowAd() {
            try {
                if (typeof show_10197154 === 'function') {
                    show_10197154().then(() => {
                        console.log("Ad shown");
                    });
                    impressions++;
                    impEl.innerText = impressions;
                } else {
                    console.log("Ad function not ready yet");
                }
            } catch (e) { console.error(e); }
        }

        function cleanupAds() {
            console.log("Cleaning up...");
            // iframe রিমুভ
            document.querySelectorAll('iframe').forEach(el => el.remove());
            // পপআপ ডিভ রিমুভ
            document.querySelectorAll('div').forEach(el => {
                const style = window.getComputedStyle(el);
                if (style.position === 'fixed' && style.zIndex > 999) {
                    el.remove();
                }
            });
            // পুরানো স্ক্রিপ্ট রিমুভ (যদিও loadAdScript এটা হ্যান্ডেল করে, তবুও সেফটি)
            document.getElementById('ad-script-container').innerHTML = '';
        }

        function countdown(seconds, text) {
            return new Promise(resolve => {
                statusEl.innerText = text;
                let timeLeft = seconds;
                
                const interval = setInterval(() => {
                    timerEl.innerText = timeLeft < 10 ? `0${timeLeft}` : timeLeft;
                    timeLeft--;
                    if (timeLeft < 0) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 1000);
            });
        }
    </script>
</body>
</html>

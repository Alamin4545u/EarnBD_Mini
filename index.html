<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnPro Mini App</title>
    <!-- SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <div id="script_container"></div>
</head>
<body class="bg-[#0b0e14] text-white font-sans">

    <!-- Navbar -->
    <header class="p-4 bg-slate-900 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-3">
            <img id="u_photo" class="w-10 h-10 rounded-full border border-blue-500" src="">
            <span id="u_name" class="font-bold text-sm text-gray-300">Syncing...</span>
        </div>
        <div class="text-right">
            <span id="ip_txt" class="text-[9px] block text-gray-500 font-mono">0.0.0.0</span>
            <span id="country_txt" class="text-[10px] text-blue-400 font-bold">DETECTING IP...</span>
        </div>
    </header>

    <!-- Stats -->
    <div class="p-8 space-y-8 max-w-md mx-auto">
        <div class="bg-slate-900/50 p-8 rounded-[2.5rem] border border-white/5 text-center shadow-2xl backdrop-blur-md">
            <p class="text-[10px] text-gray-500 uppercase tracking-widest font-black mb-2">My Impressions</p>
            <h2 id="impr_txt" class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-400 to-purple-600">0</h2>
        </div>

        <div class="space-y-4 text-center">
            <button id="start_btn" onclick="toggleAuto()" class="w-full bg-blue-600 hover:bg-blue-700 py-5 rounded-3xl font-black text-xl shadow-lg transition-all active:scale-95">
                START AUTO MODE âš¡
            </button>
            <p id="status_msg" class="text-xs text-yellow-500 italic font-medium">System ready. Click start.</p>
        </div>
    </div>

    <script>
        // --- à¦¸à§à¦¨à¦¿à¦°à§à¦¦à¦¿à¦·à§à¦Ÿà¦­à¦¾à¦¬à§‡ à¦à¦•à¦¬à¦¾à¦°à¦‡ à¦¡à¦¿à¦•à§à¦²à§‡à¦¯à¦¼à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡ ---
        (function() {
            const SB_URL = 'https://shynfkdspsjyllytsmfd.supabase.co';
            const SB_KEY = 'sb_publishable_JenZz9hQLPduBYTLapuBzQ_xiQztzWF';
            
            // supabase à¦¡à¦¿à¦•à§à¦²à§‡à¦¯à¦¼à¦¾à¦° à¦•à¦°à¦¾à¦° à¦†à¦—à§‡ à¦šà§‡à¦• à¦•à¦°à§‡ à¦¨à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦šà§à¦›à§‡
            const supabase = window.supabase.createClient(SB_URL, SB_KEY);
            const tg = window.Telegram.WebApp;

            let user = tg.initDataUnsafe.user || {id: 'tester', first_name: 'Guest'};
            let zoneId = "";
            let isRunning = false;

            // Global Scope à¦ à¦«à¦¾à¦‚à¦¶à¦¨à¦Ÿà¦¿ à¦¦à¦¿à§Ÿà§‡ à¦¦à§‡à¦“à§Ÿà¦¾ à¦¹à¦²à§‹ à¦¯à¦¾à¦¤à§‡ à¦¬à¦¾à¦Ÿà¦¨ à¦–à§à¦à¦œà§‡ à¦ªà¦¾à§Ÿ
            window.toggleAuto = function() {
                isRunning = !isRunning;
                const btn = document.getElementById('start_btn');
                if(isRunning) {
                    btn.innerText = "STOP AUTO MODE ðŸ›‘";
                    btn.classList.replace('bg-blue-600', 'bg-red-600');
                    startLoop();
                } else {
                    location.reload(); 
                }
            };

            async function init() {
                try {
                    // à§§. à¦¸à§‡à¦Ÿà¦¿à¦‚à¦¸ à¦¥à§‡à¦•à§‡ à¦œà§‹à¦¨ à¦†à¦‡à¦¡à¦¿ à¦†à¦¨à¦¾
                    const { data: config } = await supabase.from('settings').select('*').eq('key', 'ad_zone_id').single();
                    if(config) zoneId = config.value;

                    // à§¨. à¦œà§‹à¦¨ à¦†à¦‡à¦¡à¦¿ à¦…à¦¨à§à¦¯à¦¾à§Ÿà§€ à¦¸à§à¦•à§à¦°à¦¿à¦ªà§à¦Ÿ à¦²à§‹à¦¡
                    if(zoneId) {
                        const s = document.createElement('script');
                        s.src = `//alwingulla.com/88/tag.min.js`;
                        s.dataset.zone = zoneId;
                        document.getElementById('script_container').appendChild(s);
                    }

                    // à§©. à¦†à¦‡à¦ªà¦¿ à¦à¦¬à¦‚ à¦‡à¦‰à¦œà¦¾à¦° à¦¸à¦¿à¦™à§à¦•
                    const ipRes = await fetch('https://ip-api.com/json/');
                    const ipData = await ipRes.json();
                    
                    document.getElementById('u_name').innerText = user.first_name;
                    if(user.photo_url) document.getElementById('u_photo').src = user.photo_url;
                    document.getElementById('ip_txt').innerText = ipData.query;
                    document.getElementById('country_txt').innerText = ipData.country;

                    let { data: uData } = await supabase.from('users').select('*').eq('telegram_id', user.id).single();
                    if(!uData) {
                        const { data: created } = await supabase.from('users').insert([{
                            telegram_id: user.id.toString(),
                            first_name: user.first_name,
                            username: user.username,
                            photo_url: user.photo_url,
                            country: ipData.country,
                            ip_address: ipData.query
                        }]).select().single();
                        uData = created;
                    }
                    document.getElementById('impr_txt').innerText = uData.impressions || 0;
                } catch (e) { console.error("Init Error:", e); }
            }

            async function startLoop() {
                if(!isRunning) return;
                document.getElementById('status_msg').innerText = "Waiting 15s for next ad...";
                setTimeout(() => {
                    if(isRunning) showAd();
                }, 15000);
            }

            function showAd() {
                const showFn = `show_${zoneId}`;
                if (typeof window[showFn] === 'function') {
                    document.getElementById('status_msg').innerText = "Ad is loading...";
                    window[showFn]().then(async () => {
                        // à¦‡à¦®à¦ªà§à¦°à§‡à¦¶à¦¨ à¦†à¦ªà¦¡à§‡à¦Ÿ
                        await supabase.rpc('increment_stats', { tid: user.id.toString(), col_name: 'impressions' });
                        const { data } = await supabase.from('users').select('impressions').eq('telegram_id', user.id).single();
                        document.getElementById('impr_txt').innerText = data.impressions;
                        tg.HapticFeedback.notificationOccurred('success');
                        
                        document.getElementById('status_msg').innerText = "Success! 2s gap...";
                        setTimeout(startLoop, 2000);
                    }).catch(() => {
                        document.getElementById('status_msg').innerText = "Ad failed! Retrying...";
                        setTimeout(startLoop, 5000);
                    });
                } else {
                    document.getElementById('status_msg').innerText = "Waiting for ad script...";
                    setTimeout(startLoop, 3000);
                }
            }

            init();
        })();
    </script>
</body>
</html>

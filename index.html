<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Impression App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <div id="ad_tag_container"></div>
</head>
<body class="bg-slate-950 text-white min-h-screen">

    <div class="p-5 flex justify-between items-center bg-slate-900 border-b border-slate-800">
        <div id="u_name" class="font-bold text-sm">Loading...</div>
        <div id="proxy_badge" class="px-3 py-1 rounded-full text-[10px] bg-red-600">IP Check...</div>
    </div>

    <div class="p-8 space-y-6">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 text-center">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Impressions</div>
                <div id="impr_txt" class="text-3xl font-black text-blue-500">0</div>
            </div>
            <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 text-center">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Target</div>
                <div id="limit_txt" class="text-3xl font-black text-yellow-500">0</div>
            </div>
        </div>

        <button onclick="handleAdClick()" id="ad_btn" disabled class="w-full bg-blue-600 disabled:bg-slate-800 py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-all">
            Watch Ad âš¡
        </button>
        <p id="msg" class="text-center text-xs text-yellow-500 font-medium"></p>
    </div>

    <script>
        const SB_URL = 'https://shynfkdspsjyllytsmfd.supabase.co';
        const SB_KEY = 'sb_publishable_JenZz9hQLPduBYTLapuBzQ_xiQztzWF';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        let user = tg.initDataUnsafe.user || {id: 'tester_id', first_name: 'Tester'};
        let dbUser = null;
        let config = {};

        async function init() {
            document.getElementById('u_name').innerText = user.first_name;
            
            // à§§. à¦¸à§‡à¦Ÿà¦¿à¦‚à¦¸ à¦²à§‹à¦¡ à¦•à¦°à¦¾
            const { data } = await supabase.from('settings').select('*');
            if(data) data.forEach(s => config[s.key] = s.value);

            // à§¨. à¦…à§à¦¯à¦¾à¦¡ à¦Ÿà§à¦¯à¦¾à¦— à¦²à§‹à¦¡ à¦•à¦°à¦¾
            const adScript = document.createElement('script');
            adScript.src = `//alwingulla.com/88/tag.min.js`;
            adScript.dataset.zone = config.ad_zone_id;
            document.getElementById('ad_tag_container').appendChild(adScript);

            // à§©. à¦ªà§à¦°à¦•à§à¦¸à¦¿ à¦šà§‡à¦• à¦à¦¬à¦‚ à¦‡à¦‰à¦œà¦¾à¦° à¦¡à¦¾à¦Ÿà¦¾ à¦¸à¦¿à¦™à§à¦•
            await checkIPAndSync();
        }

        async function checkIPAndSync() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const ipData = await res.json();
                const userCountry = ipData.country_name;
                const allowed = config.allowed_countries.split(',').map(c => c.trim());

                // à¦‡à¦‰à¦œà¦¾à¦° à¦¡à¦¾à¦Ÿà¦¾à¦¬à§‡à¦¸à§‡ à¦†à¦›à§‡ à¦•à¦¿ à¦¨à¦¾ à¦¦à§‡à¦–à¦¾
                let { data: uData } = await supabase.from('users').select('*').eq('telegram_id', user.id).single();
                
                if(!uData) {
                    const { data: newUser } = await supabase.from('users').insert([{
                        telegram_id: user.id.toString(),
                        first_name: user.first_name,
                        country: userCountry,
                        daily_limit: parseInt(config.default_limit)
                    }]).select().single();
                    uData = newUser;
                } else {
                    await supabase.from('users').update({ country: userCountry }).eq('telegram_id', user.id);
                }
                
                dbUser = uData;
                updateAppUI(allowed.includes(userCountry), userCountry);
            } catch (e) { console.error(e); }
        }

        function updateAppUI(isAllowed, country) {
            document.getElementById('impr_txt').innerText = dbUser.impressions;
            document.getElementById('limit_txt').innerText = dbUser.daily_limit;
            const badge = document.getElementById('proxy_badge');
            badge.innerText = country;

            if (isAllowed) {
                badge.classList.replace('bg-red-600', 'bg-green-600');
                if(dbUser.impressions < dbUser.daily_limit) {
                    document.getElementById('ad_btn').disabled = false;
                    document.getElementById('msg').innerText = "âœ… High CPM Proxy Connected!";
                } else {
                    document.getElementById('msg').innerText = "ðŸš« Limit Over for today!";
                }
            } else {
                document.getElementById('msg').innerText = `âŒ Connect to: ${config.allowed_countries}`;
            }
        }

        async function handleAdClick() {
            const adFn = `show_${config.ad_zone_id}`;
            if (typeof window[adFn] === 'function') {
                window[adFn]().then(async () => {
                    const { data } = await supabase.from('users')
                        .update({ impressions: dbUser.impressions + 1 })
                        .eq('telegram_id', user.id).select().single();
                    dbUser = data;
                    updateAppUI(true, dbUser.country);
                });
            } else {
                alert("Ad script not ready. Check Zone ID.");
            }
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Impression App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Dynamic Ad Tag will be loaded here -->
    <div id="ad_script_container"></div>
</head>
<body class="bg-black text-white">

    <div class="p-5 flex justify-between items-center bg-gray-900">
        <div id="u_name" class="font-bold">Loading...</div>
        <div id="proxy_badge" class="px-2 py-1 rounded text-xs bg-red-600">Checking Proxy...</div>
    </div>

    <div class="p-10 text-center space-y-6">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-gray-800 p-5 rounded-xl">
                <div class="text-xs text-gray-400">Impressions</div>
                <div id="impr_txt" class="text-3xl font-bold">0</div>
            </div>
            <div class="bg-gray-800 p-5 rounded-xl">
                <div class="text-xs text-gray-400">Limit</div>
                <div id="limit_txt" class="text-3xl font-bold">0/0</div>
            </div>
        </div>

        <button onclick="showAd()" id="ad_btn" disabled class="w-full bg-blue-600 disabled:bg-gray-700 py-4 rounded-2xl font-bold text-xl">
            Watch Ad âš¡
        </button>
        <p id="msg" class="text-sm text-yellow-500"></p>
    </div>

    <script>
        const SB_URL = 'https://shynfkdspsjyllytsmfd.supabase.co';
        const SB_KEY = 'sb_publishable_JenZz9hQLPduBYTLapuBzQ_xiQztzWF';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        let user = tg.initDataUnsafe.user || {id: '12345', first_name: 'Guest'};
        let dbUser = null;
        let settings = {};

        async function init() {
            document.getElementById('u_name').innerText = user.first_name;
            
            // 1. Load Admin Settings
            const { data: sData } = await supabase.from('settings').select('*');
            sData.forEach(s => settings[s.key] = s.value);

            // 2. Load Ad Script
            const script = document.createElement('script');
            script.src = `//alwingulla.com/88/tag.min.js`;
            script.dataset.zone = settings.ad_zone_id;
            document.getElementById('ad_script_container').appendChild(script);

            // 3. Check Proxy/Country
            await checkProxy();
            
            // 4. Load/Sync User
            await syncUser();
        }

        async function checkProxy() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                const userCountry = data.country_name;
                const allowed = settings.allowed_countries.split(',').map(c => c.trim());

                const badge = document.getElementById('proxy_badge');
                badge.innerText = userCountry;

                if (allowed.includes(userCountry)) {
                    badge.classList.replace('bg-red-600', 'bg-green-600');
                    document.getElementById('ad_btn').disabled = false;
                    document.getElementById('msg').innerText = "âœ… Proxy match! You can work.";
                } else {
                    document.getElementById('msg').innerText = `âŒ Connect to one of these: ${settings.allowed_countries}`;
                }
            } catch (e) { console.error(e); }
        }

        async function syncUser() {
            let { data } = await supabase.from('users').select('*').eq('telegram_id', user.id).single();
            if (!data) {
                const { data: newUser } = await supabase.from('users').insert([{
                    telegram_id: user.id.toString(),
                    first_name: user.first_name,
                    daily_limit: parseInt(settings.default_limit)
                }]).select().single();
                dbUser = newUser;
            } else {
                dbUser = data;
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('impr_txt').innerText = dbUser.impressions;
            document.getElementById('limit_txt').innerText = `${dbUser.impressions}/${dbUser.daily_limit}`;
            if(dbUser.impressions >= dbUser.daily_limit) {
                document.getElementById('ad_btn').disabled = true;
                document.getElementById('msg').innerText = "ðŸš« Daily Limit Over!";
            }
        }

        function showAd() {
            const functionName = `show_${settings.ad_zone_id}`;
            if (typeof window[functionName] === 'function') {
                window[functionName]().then(async () => {
                    // Update DB
                    const { data } = await supabase.from('users')
                        .update({ impressions: dbUser.impressions + 1 })
                        .eq('telegram_id', user.id).select().single();
                    dbUser = data;
                    updateUI();
                });
            } else {
                alert("Ad not ready or wrong Zone ID!");
            }
        }

        init();
    </script>
</body>
</html>
